/*********************************************************************************************************************
 * @file        servo.c
 * @brief       舵机驱动模块，提供角度控制功能
 * @version     1.1
 * @date        2023-10-27
 * @author      (Your Name)
 *
 * @note
 * V1.0 2023-10-26: 初始版本，实现基本的角度设置功能。
 * V1.1 2023-10-27: 优化代码，使用宏定义消除魔法数字，提高可读性和可维护性。
 *                  增加了更详细的注释说明。
 *
 * 本模块基于逐飞科技 Stellar-SR5E1E3 开源库进行开发。
 ********************************************************************************************************************/

#include "servo.h"                  // 包含舵机模块自己的头文件
#include "zf_libraries_headfile.h"  // 必须包含逐飞库的头文件才能使用 zf_... 系列函数

//====================================================================================================================
// 模块配置区
//====================================================================================================================

//--------------------------------------------------------------------------------------------------------------------
// 1. 硬件连接配置 (Hardware Connection Configuration)
//    请根据你的实际接线，修改下面的宏定义。这是使用本模块前必须确认的一步。
//
//    - SERVO_PWM_CH:   舵机信号线连接的PWM通道。
//                      你可以在 zf_driver_pwm.h 文件中找到所有可用的PWM通道定义。
//                      例如，如果你的舵机接在了 H0 引脚上，这里就应该是 PWM_TIM3_CH3_H0。
//
//    - SERVO_PWM_TIMER: SERVO_PWM_CH 所属的定时器。
//                       例如，PWM_TIM3_CH3_H0 属于 PWM_TIM3 定时器。
//--------------------------------------------------------------------------------------------------------------------
#define SERVO_PWM_CH            (PWM_TIM8_CH1_I0)
#define SERVO_PWM_TIMER         (PWM_TIM8)


//--------------------------------------------------------------------------------------------------------------------
// 2. 舵机参数配置 (Servo Parameter Configuration)
//    这部分定义了舵机的物理和信号特性，微调可以提高控制精度。
//--------------------------------------------------------------------------------------------------------------------
#define SERVO_FREQUENCY_HZ          (50)    // 舵机控制频率，标准为 50Hz，一般不建议修改
#define SERVO_PERIOD_US             (1000000 / SERVO_FREQUENCY_HZ) // 自动计算PWM周期 (单位: 微秒)

// 定义舵机的物理角度限制，用于映射
#define SERVO_MIN_ANGLE             (0)
#define SERVO_MAX_ANGLE             (180)

// 定义舵机在最小和最大角度时对应的脉冲宽度（单位：微秒 us）。
// 500us-2500us 是一个比较宽泛且兼容性好的范围，适用于大多数舵机。
// 你可以根据你的舵机手册或实际测试进行微调，以获得更精确的角度。
#define SERVO_MIN_PULSE_WIDTH_US    (500)
#define SERVO_MAX_PULSE_WIDTH_US    (2500)


//====================================================================================================================
// 函数实现区
//====================================================================================================================

/**
 * @brief      舵机模块初始化
 * @details    该函数会根据上面配置的参数，初始化用于舵机控制的PWM模块和通道。
 *             应该在主程序的开始部分被调用一次。
 */
void servo_init(void)
{
    // 初始化舵机使用的PWM定时器模块，频率必须设置为 SERVO_FREQUENCY_HZ
    zf_pwm_module_init(SERVO_PWM_TIMER, PWM_ALIGNMENT_EDGE, SERVO_FREQUENCY_HZ);

    // 初始化舵机连接的PWM通道，初始占空比为0（舵机无力）
    // 如果希望上电后舵机直接回到某个位置（如中位90度），可以调用 set_servo_angle(90);
    zf_pwm_channel_init(SERVO_PWM_CH, 0);
}


/**
 * @brief      设置舵机旋转到指定角度
 * @param      angle   目标角度，有效范围由 SERVO_MIN_ANGLE 和 SERVO_MAX_ANGLE 定义。
 *                     超出范围的值会被自动限制在范围内。
 * @details    本函数将输入的角度值，通过线性映射计算出对应的脉冲宽度，
 *             再转换为逐飞库所需的占空比数值，最后通过PWM信号驱动舵机。
 */
void set_servo_angle(int angle)
{
    uint32_t pulse_width_us;
    uint16_t duty_value;

    // --- 步骤 1: 对输入角度进行限幅，防止超出物理范围 ---
    if (angle < SERVO_MIN_ANGLE)
    {
        angle = SERVO_MIN_ANGLE;
    }
    if (angle > SERVO_MAX_ANGLE)
    {
        angle = SERVO_MAX_ANGLE;
    }

    // --- 步骤 2: 将角度值线性映射到脉冲宽度 (单位: us) ---
    // 这是一个标准的线性映射公式: y = y_min + (x - x_min) * (y_max - y_min) / (x_max - x_min)
    pulse_width_us = SERVO_MIN_PULSE_WIDTH_US +
                     (uint32_t)((angle - SERVO_MIN_ANGLE) * (SERVO_MAX_PULSE_WIDTH_US - SERVO_MIN_PULSE_WIDTH_US) / (SERVO_MAX_ANGLE - SERVO_MIN_ANGLE));

    // --- 步骤 3: 将计算出的脉冲宽度(us)转换为逐飞库所需的占空比值 ---
    // 库占空比值 = (脉宽 / 总周期) * 库定义的最大占空比值
    // 使用宏定义，避免在代码中出现魔法数字
    duty_value = (uint16_t)((pulse_width_us * PWM_DUTY_MAX) / SERVO_PERIOD_US);

    // --- 步骤 4: 设置PWM占空比，驱动舵机转动 ---
    zf_pwm_set_duty(SERVO_PWM_CH, duty_value);
}
